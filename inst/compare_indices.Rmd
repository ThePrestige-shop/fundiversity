---
title: "Comparing Functional Diversity Indices Across Package"
author: "Matthias Grenié & Hugo Gruson"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Functions --------------------------------------------------------------------

join_list_by_site = function(df_list) {
  Reduce(function(x, y) inner_join(x, y, by = "site"), df_list)
}
```

In this Rmarkdown we will be taking notes to identify the differences in
computation across packages of the, theoretically, same functional diversity
indices.

## Preamble

We first need to load the packages that we'll be needing:

```{r packages}
library("dplyr")
library("fundiversity")  # To get the data
```

Then we need to prepare the data for computation. Because we think that some
observed differences across packages may be due to standardization of the data
(without warning the user!) we also standardized the data before hand.
In this document we'll be using the bird data available out of the box from
`fundiversity`. Some indices also work with functional distances instead of
trait table so we are also compute euclidean distances between species based on
un- and standardized trait tables.

```{r input-data}
traits_birds_sc = scale(traits_birds)

trait_dist_birds = dist(traits_birds, method = "euclidean")

trait_dist_birds_sc = dist(traits_birds_sc, method = "euclidean")

```


## Functional Dispersion - FDis

In this section we'll be compute Functional Dispersion (FDis) for all the
available packages.

For each one of them we will be wrangling the data to make them comparable.

### fundiversity

```{r fdis-fundiversity}
# fundiversity
fundiversity_fdis = fd_fdis(traits_birds, site_sp_birds)

fundiversity_fdis_sc = fd_fdis(traits_birds_sc, site_sp_birds)

fundiversity_dispersions =
  list(
    fundiversity_fdis = fundiversity_fdis,
    fundiversity_fdis_sc = fundiversity_fdis_sc
  ) %>%
  purrr::imap(
    ~.x %>%
      rename(!!.y := FDis)
  ) %>%
  join_list_by_site()

```


### BAT

```{r fdis-bat}

# BAT
# Noticeable difference when using raw traits: creates a functional tree...
BAT_dispersion_traits = BAT::dispersion(
  site_sp_birds, tree = traits_birds
)

BAT_dispersion_traits_sc = BAT::dispersion(
  site_sp_birds, tree = traits_birds_sc
)

# Not sure how dissimilarity are taken?
BAT_dispersion_dist = BAT::dispersion(
  site_sp_birds, distance = trait_dist_birds
)

BAT_dispersion_dist_sc = BAT::dispersion(
  site_sp_birds, distance = trait_dist_birds_sc
)

BAT_dispersions = list(
  BAT_traits = BAT_dispersion_traits,
  BAT_traits_sc = BAT_dispersion_traits_sc,
  BAT_dist = BAT_dispersion_dist,
  BAT_dist_sc = BAT_dispersion_dist_sc
) %>%
  purrr::imap(function(x, y) {
    df = x %>%
      as.data.frame() %>%
      tibble::rownames_to_column("site")

    colnames(df)[[2]] = y

    df
  }) %>%
  join_list_by_site()


```

### FD

```{r fdis-fd}
## FD
# Refer Laliberté & Legendre (2010) for functional dispersion
FD_dist = FD::fdisp(trait_dist_birds, site_sp_birds)

FD_dist_sc = FD::fdisp(trait_dist_birds_sc, site_sp_birds)

FD_dispersions =
  list(
    FD_dist = FD_dist,
    FD_dist_sc = FD_dist_sc
  ) %>%
  purrr::imap(
    ~.x[["FDis"]] %>%
      tibble::enframe(name = "site", value = .y)
  ) %>%
  join_list_by_site()

```


### mFD

```{r fdis-mfd}


# mFD::alpha.fd.multidim(..., ind_vect = "fdis")
mFD_dispersion_traits = mFD::alpha.fd.multidim(
  traits_birds, site_sp_birds, ind_vect = "fdis", scaling = FALSE,
  verbose = FALSE
)

mFD_dispersion_traits_sc = mFD::alpha.fd.multidim(
  traits_birds_sc, site_sp_birds, ind_vect = "fdis", scaling = FALSE,
  verbose = FALSE
)

mFD_dispersions = list(
  mFD_traits = mFD_dispersion_traits,
  mFD_traits_sc = mFD_dispersion_traits_sc
) %>%
  purrr::imap(
    ~.x %>%
      .[["functional_diversity_indices"]] %>%
      as.data.frame() %>%
      tibble::rownames_to_column("site") %>%
      select(site, fdis) %>%
      rename(!!.y := fdis)
  ) %>%
  join_list_by_site()

```

### hillR

```{r fdis-hillr}

# hillR
hillR_dispersion_traits = hillR::hill_func(site_sp_birds, traits_birds)
hillR_dispersion_traits_sc = hillR::hill_func(site_sp_birds, traits_birds_sc)

hillR_dispersions = list(
  hillR_traits = hillR_dispersion_traits,
  hillR_traits_sc = hillR_dispersion_traits_sc
) %>%
  purrr::imap(
    ~.x %>%
      .["FDis", ] %>%
      tibble::enframe("site", "fdis") %>%
      rename(!!.y := fdis)
  ) %>%
  join_list_by_site()

```


### Values and plots

To compare computed values across packages we plot all of their pairwise
correlations:

```{r fdis-table}
all_fdis = list(
  fundiversity_dispersions,
  BAT_dispersions,
  FD_dispersions,
  mFD_dispersions,
  hillR_dispersions
) %>%
  {Reduce(function(x, y) inner_join(x, y, by = "site"), .)}

all_fdis
```

Based on the table, we values varying across four orders of magnitude for the
same site. So even if the packages claim to measure the same value, they
actually compute very different numbers! From FDis value of ~0.1 to 165.

Looking at the table we can identify columns that are exactly equal.
There are at least three clear groups:

1. The columns `FD_dist_sc`, `mFD_traits_sc`, `hillR_traits`, and
`hillR_traits_sc` all show the exact same values; the fact that `hillR_traits`
is grouped only to other scaled traits would point to the fact that `hillR` is
in fact scaling the traits without telling the user.
2. `mFD_traits` and `FD_dist` are exactly equal, while `fundiversity_fdis` is
close to them.
3. `BAT_traits` and `BAT_traits_sc` are exactly meaning that `BAT` using a
functional tree may standardize the traits beforehand or that standardization
has no effect.

This leaves out `fundiversity_fdis_sc`, `BAT_dist`, and `BAT_dist_sc` as
different from all other indices.

In addition to looking at actual values we can watch the correlation between
indices.

```{r fdis-correlations}
all_fdis %>%
    select(hillR_traits, mFD_traits, fundiversity_fdis, BAT_traits, fundiversity_fdis_sc, BAT_dist, BAT_dist_sc) %>%
    GGally::ggpairs(
      title = "Correlation between FDis from different packages", progress = FALSE
    )
```

Based on these correlations we can see that:

1. `fundiversity_fdis` is equivalent to `mFD_traits` and close to `BAT_dist`.
2. It seems that `BAT_dist` is equivalent to `fundiversity_fdis_sc`.
3. `hillR_traits` seems close to `BAT_traits` and `BAT_dist_sc`.

But for all other functions, the correlations are lower making it difficult to
see clear equivalences



